<% layout("/layouts/boilerplate") -%>

<div class="container" style="max-width: 900px; margin: 50px auto;">
  <div class="card shadow-lg" style="border-radius: 20px; overflow: hidden;">
    <div class="row g-0">
      <!-- Medicine Image -->
      <div class="col-md-5">
        <div class="medicine-image-container">
          <img src="<%= medicine.image.url %>" class="img-fluid medicine-detail-img" alt="<%= medicine.name %>">
          <% if (medicine.prescriptionRequired) { %>
            <div class="rx-badge-large">
              <i class="fas fa-prescription-bottle-alt"></i> Rx Required
            </div>
          <% } %>
        </div>
      </div>

      <!-- Medicine Details -->
      <div class="col-md-7">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <span class="badge bg-primary mb-2"><%= medicine.category %></span>
              <h2 class="medicine-title"><%= medicine.name %></h2>
              <p class="text-muted mb-1">
                <i class="fas fa-industry"></i> <%= medicine.manufacturer %>
              </p>
            </div>
          </div>

          <div class="price-section mb-4">
            <h3 class="price-tag">â‚¹<%= medicine.price %></h3>
            <% if (medicine.packSize) { %>
              <p class="text-muted"><%= medicine.packSize %></p>
            <% } %>
          </div>

          <div class="medicine-info mb-4">
            <h5><i class="fas fa-heartbeat text-danger"></i> Uses</h5>
            <p><%= medicine.uses %></p>

            <% if (medicine.description) { %>
              <h5 class="mt-3"><i class="fas fa-info-circle text-info"></i> Description</h5>
              <p><%= medicine.description %></p>
            <% } %>

            <% if (medicine.dosage) { %>
              <p class="mb-2">
                <strong><i class="fas fa-prescription text-primary"></i> Dosage:</strong> <%= medicine.dosage %>
              </p>
            <% } %>

            <p class="mb-2">
              <strong><i class="fas fa-cubes text-success"></i> Stock:</strong>
              <% if (medicine.stockQuantity > 10) { %>
                <span class="text-success">In Stock (<%= medicine.stockQuantity %> available)</span>
              <% } else if (medicine.stockQuantity > 0) { %>
                <span class="text-warning">Limited Stock (<%= medicine.stockQuantity %> left)</span>
              <% } else { %>
                <span class="text-danger">Out of Stock</span>
              <% } %>
            </p>
          </div>

          <!-- Action Buttons -->
          <div class="button-group">
            <% if (currentUser && medicine.owner.equals(currentUser._id)) { %>
              <a href="/medicines/<%= medicine._id %>/edit" class="btn btn-warning btn-lg flex-fill">
                <i class="fas fa-edit"></i> Edit
              </a>
              <form method="POST" action="/medicines/<%= medicine._id %>?_method=DELETE" class="flex-fill">
                <button class="btn btn-danger btn-lg w-100" onclick="return confirm('Are you sure you want to delete this medicine?')">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </form>
            <% } else { %>
              <button class="btn btn-success btn-lg flex-fill" onclick="addToCart('<%= medicine._id %>', '<%= medicine.name %>', <%= medicine.price %>)">
                <i class="fas fa-shopping-cart"></i> Add to Cart
              </button>
              <button class="btn btn-primary btn-lg flex-fill" onclick="buyNow('<%= medicine._id %>', '<%= medicine.name %>', <%= medicine.price %>)">
                <i class="fas fa-bolt"></i> Buy Now
              </button>
            <% } %>
          </div>

          <a href="/medicines" class="btn btn-link mt-3">
            <i class="fas fa-arrow-left"></i> Back to All Medicines
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .medicine-image-container {
    position: relative;
    height: 100%;
    min-height: 400px;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .medicine-detail-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 30px;
  }

  .rx-badge-large {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #dc3545;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 700;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }

  .medicine-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 10px;
  }

  .price-section {
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    padding: 20px;
    border-radius: 12px;
  }

  .price-tag {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0;
  }

  .medicine-info h5 {
    color: #2d3748;
    font-weight: 600;
    margin-bottom: 10px;
  }

  .button-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  @media (max-width: 768px) {
    .medicine-image-container {
      min-height: 300px;
    }
    
    .button-group {
      flex-direction: column;
    }
  }
</style>

<script>
  function addToCart(id, name, price) {
    let cart = JSON.parse(localStorage.getItem("medicineCart")) || [];
    const existingIndex = cart.findIndex(item => item.id === id);
    
    if (existingIndex !== -1) {
      cart[existingIndex].quantity += 1;
    } else {
      cart.push({ id, name, price, quantity: 1 });
    }
    
    localStorage.setItem("medicineCart", JSON.stringify(cart));
    alert(name + " added to cart!");
    window.location.reload();
  }

  function buyNow(id, name, price) {
    window.location.href = `/medicines/${id}`;
  }
</script>

